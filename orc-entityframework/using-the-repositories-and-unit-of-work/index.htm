<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Using the repositories & unit of work - WildGums open source center</title>
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../css/theme_colors.css" type="text/css" />
    <link rel="stylesheet" href="../../css/styles/vs.css">
    <link rel="stylesheet" href="../../css/font-awesome.4.5.0.min.css">
</head>
<body role="document">
    <div class="grid-for-nav">
        <nav data-toggle="nav-shift" class="nav-side stickynav">
            <div class="side-nav-search">
                <a href="/index.htm"><i class="fa fa-home"></i> WildGums open source center</a>
                <div role="search">
                    <form id="search-form" class="form" action="../../Docnet_search.htm" method="get">
                        <input type="text" name="q" placeholder="Search docs" />
                    </form>
                </div>
            </div>
            <div class="menu menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
<ul>
<li class="tocentry"><a href="../../home.htm">Home</a>
</li>
<li class="tocentry"><a href="../../introduction/">Introduction</a>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orchestra/">Orchestra</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-analytics/">Orc.Analytics</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-automaticsupport/">Orc.AutomaticSupport</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-commandline/">Orc.CommandLine</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-controls/">Orc.Controls</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-csvhelper/">Orc.CsvHelper</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-csvtexteditor/">Orc.CsvTextEditor</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-dbtocsv/">Orc.DbToCsv</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-dependencygraph/">Orc.DependencyGraph</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-dynamicobjects/">Orc.DynamicObjects</a></span>
</li>
<li class="tocentry">
<ul>
<li><span class="navigationgroup"><i class="fa fa-caret-down"></i> <a href="../../orc-entityframework/">Orc.EntityFramework</a></span></li>
<li class="tocentry"><a href="../../orc-entityframework/introduction/">Introduction</a>
</li>
<li class="tocentry"><a href="../../orc-entityframework/using-the-dbcontextmanager/">Using the DbContextManager</a>
</li>
<li class="tocentry current"><a class="current" href="../../orc-entityframework/using-the-repositories-and-unit-of-work/">Using the repositories & unit of work</a>
<ul class="currentrelative">
<li class="tocentry"><a href="#overview-of-unit-of-work-and-repositories">Overview of Unit of Work and repositories</a></li>

<li class="tocentry"><a href="#creating-a-unit-of-work">Creating a Unit of Work</a></li>

<li class="tocentry"><a href="#creating-a-repository">Creating a repository</a></li>

<li class="tocentry"><a href="#retrieving-repositories-from-a-unit-of-work">Retrieving repositories from a Unit of Work</a></li>
<li class="tocentry">
<ul class="currentrelative">
<li class="tocentry"><a href="#saving-a-unit-of-work">Saving a Unit of Work</a></li>


</ul>
</li>



</ul>
<li class="tocentry"><a href="../../orc-entityframework/using-stored-procedures-and-functions/">Using stored procedures & functions</a>
</li>
<li class="tocentry"><a href="../../orc-entityframework/using-the-modelbase-as-base-class-for-code-first-entities/">Using the ModelBase as base class for code-first entities</a>
</li>

</ul>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-extensibility/">Orc.Extensibility</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-feedback/">Orc.Feedback</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-fileassociation/">Orc.FileAssociation</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-filesystem/">Orc.FileSystem</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-filterbuilder/">Orc.FilterBuilder</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-fluentvalidation/">Orc.FluentValidation</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-licensemanager/">Orc.LicenseManager</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-logviewer/">Orc.LogViewer</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-memento/">Orc.Memento</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-metadata/">Orc.Metadata</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-notifications/">Orc.Notifications</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-nugetexplorer/">Orc.NuGetExplorer</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-prism/">Orc.Prism</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-projectmanagement/">Orc.ProjectManagement</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-scheduling/">Orc.Scheduling</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-search/">Orc.Search</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-skia/">Orc.Skia</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-snapshots/">Orc.Snapshots</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-sort/">Orc.Sort</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-squirrel/">Orc.Squirrel</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-supportpackage/">Orc.SupportPackage</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-systeminfo/">Orc.SystemInfo</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-wizard/">Orc.Wizard</a></span>
</li>
<li class="tocentry">
<span class="navigationgroup"><i class="fa fa-caret-right"></i> <a href="../../orc-workspacemanagement/">Orc.WorkspaceManagement</a></span>
</li>

</ul>
				<div class="toc-footer">
					<span class="text-small">
						<hr/>
						<a href="https://github.com/FransBouma/DocNet" target="_blank">Made with <i class="fa fa-github"></i> DocNet</a>
					</span>
				</div>	
			</div>
            &nbsp;
        </nav>
        <section data-toggle="nav-shift" class="nav-content-wrap">
            <nav class="nav-top" role="navigation" aria-label="top navigation">
                <i data-toggle="nav-top" class="fa fa-bars"></i>
                <a href="../../index.htm">WildGums open source center</a>
            </nav>
            <div class="nav-content">
                <div role="navigation" aria-label="breadcrumbs navigation">
                    <div class="breadcrumbs">
<ul><li><a href="../../home.htm">Home</a></li> / <li><a href="../../orc-entityframework/index.htm">Orc.EntityFramework</a></li> / <li><a href="../../orc-entityframework/using-the-repositories-and-unit-of-work/index.htm">Using the repositories & unit of work</a></li></ul>

                    </div>
                    <hr />
                </div>
                <div role="main">
                    <div class="section">
<h1 id="using-the-repositories-and-unit-of-work">Using the repositories and unit of work<a class="headerlink" href="#using-the-repositories-and-unit-of-work" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h1>
<p>The Repository and Unit of Work (UoW) pattern are very useful patterns to create an abstraction level over the <em>DbContext</em> that is provided by Entity Framework. A much heard excuse not to use repositories is that EF itself already works with repositories (the <em>DbContext</em>) and a UoW (in the SaveChanges method). Below are a few examples why it is a good thing to create repositories:</p>
<ul>
<li>Abstract away some of the more complex features of Entity Framework that the end-developer should not be bothered with</li>
<li>Hide the actual <em>DbContext</em> (make it internal) to prevent misuse</li>
<li>Keep security checks and saving and rollback in a single location</li>
<li>Force the use of the <em>Specification</em> pattern on queries</li>
</ul>
<div class="alert alert-info"><span class="alert-title"><i class="fa fa-info-circle"></i> Info</span><p>Note that repositories and UoW should not be used to abstract away the ORM tool because that is just another abstraction layer which is not required. Use it for the advantages mentioned above</p>
</div><p>A Unit of Work (UoW) is a a combination of several actions that will be grouped into a transaction. This means that either all actions inside a UoW are committed or rolled back. The advantage of using a UoW is that multiple save actions to multiple Repositories can be grouped as a unit.</p>
<p>A repository is a class or service responsible for providing objects and allowing end-developers to query data. Instead of querying the DbContext directly, the DbContext can be abstracted away to provide default queries and force required functionality to all end-developers of the DbContext.</p>
<h2 id="overview-of-unit-of-work-and-repositories">Overview of Unit of Work and repositories<a class="headerlink" href="#overview-of-unit-of-work-and-repositories" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>There are different interpretations of how repositories should be used in combination with unit of work. Let's start with an overview how the DbContext, Repositories and Unit of Work relate to each other. The image below represents an overview of the situation as Catel deals with the DbContext, Repositories and Unit of Work:</p>
<p>[image here]</p>
<p>The image above shows that the Unit of Work is the top-level component to be used. Each UoW contains its own <em>DbContext</em> instance. The <em>DbContext</em> can either be injected or will be created on the fly. Then the UoW also contains repositories which always get the <em>DbContext</em> injected. This way, all repositories inside a UoW share the same <em>DbContext</em>.</p>
<h2 id="creating-a-unit-of-work">Creating a Unit of Work<a class="headerlink" href="#creating-a-unit-of-work" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>A UoW can be created by simply instantiating it. The end-developer has the option to either inject the <em>DbContext</em> or let the <em>DbContextManager</em> take care of it automatically.</p>
<pre><code>using (var uow = new UnitOfWork&lt;MyDbContext&gt;())
{
    // get repositories and query away
}
</code></pre>

<h2 id="creating-a-repository">Creating a repository<a class="headerlink" href="#creating-a-repository" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>A repository can be created very easily by deriving from the <em>EntityRepositoryBase</em> class. Below is an example of a customer repository:</p>
<pre><code>public class CustomerRepository : EntityRepositoryBase&lt;Customer, int&gt;, ICustomerRepository
{
    public CustomerRepository(DbContext dbContext)
        : base(dbContext)
    {
    }
}
 
public interface ICustomerRepository : IEntityRepository&lt;Customer, int&gt;
{
}
</code></pre>

<h2 id="retrieving-repositories-from-a-unit-of-work">Retrieving repositories from a Unit of Work<a class="headerlink" href="#retrieving-repositories-from-a-unit-of-work" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h2>
<p>Once a UoW is created, it can be used to resolve repositories. To retrieve a repository from the UoW, the following conditions must be met:</p>
<ol>
<li>The repository must be registered in the ServiceLocator as Transient type. If the repository is declared as non-transient, it will be instantiated as new instance anyway.</li>
<li>The repository must have a constructor accepting a DbContext instance</li>
</ol>
<p>To retrieve a new repository from the UoW, use the following code:</p>
<pre><code>using (var uow = new UnitOfWork&lt;MyDbContext&gt;())
{
    var customerRepository = uow.GetRepository&lt;ICustomerRepository&gt;();
 
    // all interaction with the customer repository is applied to the unit of work
}
</code></pre>

<h3 id="saving-a-unit-of-work">Saving a Unit of Work<a class="headerlink" href="#saving-a-unit-of-work" title="Permalink to this headline"><i class="fa fa-link" aria-hidden="true"></i></a></h3>
<p>It is very important to save a Unit of Work. Once the Unit of Work gets out of scope (outside the using), all changes will be discarded if not explicitly saved.</p>
<pre><code>using (var uow = new UnitOfWork&lt;MyDbContext&gt;())
{
    var customerRepository = uow.GetRepository&lt;ICustomerRepository&gt;();
 
    // all interaction with the customer repository is applied to the unit of work
 
    uow.SaveChanges();
}
</code></pre>


                    </div>
                </div>
                <footer>
                    <hr />
                    <div role="contentinfo">

                      <p>
					    Is this section not up-to-date or found an issue? Please <a href="https://github.com/wildgums/wildgums.opensource/blob/master/src/orc.entityframework/using-the-repositories-and-unit-of-work.md" target="_blank">contribute</a>!
					  </p>
					  <p>
					    Have a question about WildGums projects? Use <a href="https://stackoverflow.com/questions/tagged/catel" target="_blank">StackOverflow</a> with the <i>Catel</i> tag!
					  </p>
					  <hr />
					  <p>
					    <h2>Discussion</h2>
					   <div id="disqus_thread"></div>
					   <script>
					   var disqus_config = function () {
					   this.page.url = 'http://opensource.wildgums.com/orc-entityframework/using-the-repositories-and-unit-of-work/index.htm';
					   this.page.identifier = 'src/orc.entityframework/using-the-repositories-and-unit-of-work.md';
					   };
					   (function() { // DON'T EDIT BELOW THIS LINE
					   var d = document, s = d.createElement('script');
					   s.src = 'https://wildgums-opensource.disqus.com/embed.js';
					   s.setAttribute('data-timestamp', +new Date());
					   (d.head || d.body).appendChild(s);
					   })();
					   </script>
					   <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
					  </p>
					</div>
                </footer>
            </div>
        </section>
    </div>
    <script src="../../js/jquery-2.1.1.min.js"></script>
    <script src="../../js/modernizr-2.8.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script src="../../js/theme.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-54671533-18', 'auto');
      ga('send', 'pageview');
    
    </script>
</body>
</html>
